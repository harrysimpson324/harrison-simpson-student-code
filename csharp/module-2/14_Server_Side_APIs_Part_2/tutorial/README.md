# Server-Side APIs: Part 2 Tutorial

In this tutorial, you'll continue working on an application that uses Meetup Locations as the data model. You'll add the ability to update and delete a location as well as perform data validation to inform the client of any problems.

## Step One: Open solution and explore starting code

Open `ServerSideAPIsPart2Tutorial.sln` and expand the folders in the `LocationServer` project.

### DAO

In the DAO folder, there's a `LocationMemoryDao.cs` file that provides data access code. To reduce complexity, a static `List` is used instead of a real database. Also, there are some methods in there that you'll call from the controller.

### Controller

In the previous tutorial, the `LocationsController` constructor instantiated the list of locations. For this tutorial, all of the data initialization and CRUD operations are in the `LocationMemoryDao` class. This mimics using a real database, but the data is only stored in the memory of your computer.

The `LocationController` constructor receives a new DAO instance at runtime by the ASP.NET framework using Dependency Injection:

```csharp
public class LocationsController : ControllerBase
{
    private readonly ILocationDao locationDao;

    public LocationsController(ILocationDao locationDao)
    {
        this.locationDao = locationDao;
    }
}
```

The `Get()` method has also been slightly modified for you. If the DAO can find the location by the ID, it returns a `200 OK` status code. If that location doesn't exist, it returns a status code of `404 NotFound`:

```csharp
[HttpGet("{id}")]
public ActionResult<Location> Get(int id)
{
    Location location = locationDao.GetLocationById(id);
    if (location != null)
    {
        return Ok(location);
    }
    else
    {
        return NotFound();
    }
}
```

You'll have the chance to do something similar later in this tutorial when you create the `Update()` method.

## Step Two: Run your project

Now that you've set up your project in Visual Studio and reviewed the starting code, run it to make sure everything works. It's best to make sure the application runs before adding anything new to it.

## Step Three: Add Location data validation

In the previous tutorial, the `Add()` method of the controller added a new location to the `List` member in controller. This project has a DAO so the method now uses the DAO `CreateLocation()` method:

```csharp
[HttpPost]
public Location Add(Location location)
{
    Location returnLocation = locationDao.CreateLocation(location);
    return returnLocation;
}
```

What happens if the location isn't null but is missing information? For locations, you want to require all of these fields so they may not be blank:

- Name
- Address
- City
- State
- Zip

If you open `Location.cs`, you'll see the list of properties for this class. Before looking at the answer, add the `[Required]` attribute for each required property:

```csharp
public class Location
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Address { get; set; }
    public string City { get; set; }
    public string State { get; set; }
    public string Zip { get; set; }

    // ...

}
```

> `Id` isn't required because it's generated by the `LocationMemoryDao` class.

Next, add a custom message by setting the `ErrorMessage` parameter of the `[Required]` attribute. Remember that adding custom messages helps the client understand what property failed data validation:

```csharp
public class Location
{
    public int Id { get; set; }
    [Required(ErrorMessage = "The field Name is required.")]
    public string Name { get; set; }
    [Required(ErrorMessage = "The field Address is required.")]
    public string Address { get; set; }
    [Required(ErrorMessage = "The field City is required.")]
    public string City { get; set; }
    [Required(ErrorMessage = "The field State is required.")]
    public string State { get; set; }
    [Required(ErrorMessage = "The field Zip is required.")]
    public string Zip { get; set; }

    // ...

}
```

After you've defined validation rules on your model, you can declare a `Location` argument in any of your methods. If an object doesn't pass validation, ASP.NET returns a `400 BadRequest` status automatically.

## Step Four: Return proper status code for `Add()` method

Now that you have data validation in place, there's one more change you need to make to the `Add()` method. Currently, it returns the `Location` object. You now know how to return the correct status code, so you'll want to do that here.

If a new location is created, you must send back the status code `201 Created`. To do this, you'll change the return type to `ActionResult<Location>` instead of `Location`. When you return the `Created()` `ActionResult`, you'll send back the location of the new resource—that is, the URL—along with the resource itself:

```csharp
[HttpPost]
public ActionResult<Location> Add(Location location)
{
    Location returnLocation = locationDao.CreateLocation(location);
    return Created($"/locations/{returnLocation.Id}", returnLocation);
}
```

Feel free to test the `Add()` method in Postman. If you send an object with an empty string for `Name`, do you get the proper error message back?

## Step Five: Update an existing location

To update an existing location, you need to create a new controller method that responds to the `PUT` request method. A client would specify the URL to a specific location, like `locations/1`, and send the JSON data that included the updated location. 

In `LocationController`, create a new method called `Update()`:

```csharp
[HttpPut("{id}")]
public ActionResult<Location> Update(int id, Location location)
{

}
```

The return type of this method is `ActionResult<Location>` so that you can handle several scenarios that might come up. For this method, you'll call the DAO `UpdateLocation()` method. `UpdateLocation()` takes a `Location` as input. But the ID for the location to update is on the URL. It may not have been provided in the payload, or it may have been different. Either way, the ID on the URL takes precedence. Set the ID property of the `Location` object to the one from the URL.

Now the method can pass the Location to `UpdateLocation()`. If `UpdateLocation()` can't find the Location to update it throws a `DaoException`. The code must catch the exception and return `NotFound()` rather than letting the `DaoException` go to the client. If no exception is thrown then use the result as an argument to the `Ok()` `ActionResult`:

```csharp
[HttpPut("{id}")]
public ActionResult<Location> Update(int id, Location location)
{
    // The id on the URL takes precedence over the id in the request body, if any
    location.Id = id;

    try
    {
        Location result = locationDao.UpdateLocation(location);
        return Ok(result);
    }
    catch (DaoException)
    {
        return NotFound();
    }
}
```

You can test this by running a `PUT` request in Postman. If you wanted to update the "Baker Electric Building" location, the path would be `https://localhost:44387/locations/1`. Make sure to change the request method to `PUT` and the `Content-Type` to `application/json`. You can send the following object to change the title:

```json
{
    "id": 1,
    "name": "THIS IS A NEW TITLE",
    "address": "7100 Euclid Ave #14",
    "city": "Cleveland",
    "state": "OH",
    "zip": "44103"
}
```

If you try updating a location that doesn't exist, like `/locations/99`, what happens? If you try changing the name to an empty string, what happens?

> Don't worry: the changes are only stored in memory, so you won't change this permanently. If you restart your application, you'll see the data has been reset.

## Step Six: Delete a location

Add a `Delete()` method to your controller. Like `PUT`, `DELETE` targets the URL for a specific location. Unlike the update method, you won't return anything, so you'll want to make sure you return the status code `204 NoContent`.

You also want to make sure you return a `404 NotFound` if the client tries to delete a location that doesn't exist. The DAO `DeleteLocationById()` method returns the number of locations deleted by the call. This value can be used to determine whether the location was successfully deleted:

```csharp
[HttpDelete("{id}")]
public ActionResult Delete(int id)
{
    int numDeleted = locationDao.DeleteLocationById(id);
    if (numDeleted == 1)
    {
        return NoContent();
    }
    else
    {
        return NotFound();
    }
}
```

To test in Postman, run a `DELETE` on any of the existing locations. After running it and getting a successful `204 NoContent` status back, run the `GET` to list all of the locations. You'll see that your location has been deleted. Like the update method, try sending a `DELETE` request to a location that doesn't exist and see what happens.

## Summary

In this tutorial, you learned:

- How to add validation attributes to your data model.
- How to send back the proper status codes to the client.
- How to create a method that updates a resource in your controller.
- How to create a method that deletes a resource in your controller.
